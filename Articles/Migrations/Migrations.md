**Почему миграции необходимы?**

![](<1.png>)

Миграция — обновление структуры базы данных без потери данных. В процессе
разработки ПО часто приходится сталкиваться с изменением структуры БД, когда над
проектом работает команда и приложение активно использует БД, разработчик может
менять структуру базы в зависимости от потребностей (разработка новых компонент,
изменение старых).

Рассмотрим два примера:

1.  один разработчик изменил структуру БД и сделал пуш на сервер. Другой
    разработчик делает пулл и запускает проект. Проект не работает. Выход -
    пересоздать базу. Да, это не критично для разработчика, а вот для
    тестировщика у которого был определен свой набор данных для тестирования это
    будет критично (вносить нужные ему данные снова).

2.  при выпуске новой версии ПО нужно деплоить на сервер, при этом базу не
    удалять, так как клиент в процессе разработки может сам использовать
    приложение (вносить в него данные, удалять, изменять и др). Здесь могут
    возникнуть проблемы, так как новая версия (новая структура) не поддерживает
    механизмы работы с базой. И здесь есть выход, или удалять постоянно базу при
    выпуске каждой новой версии, что нам не подходит по требованиям, или
    применить миграции.

**Автоматические миграции EF Code First.**

И так, допустим у нас есть простая модель:

![](<2.png>)

Тут стоит сказать, что приложение у меня Web, поэтому в методе Index я добавлю
новую запись типа Autor, запущу проект и увижу что база проинициализировалась:

![](<3.png>)

![](<4.png>)

Теперь допустим добавим новую модель Book, и добавим в нее пару книг и запустим
проект.

![](<5.png>)

![](<6.png>)

Запустив проект получаем, как и ожидали ошибку:

![](<7.png>)

**Включаем миграции**

Открываем консоль диспетчера пакетов в VS и пишем **Enable-Migrations
–EnableAutomaticMigrations.** При этом в наш проект добавляется папка
Migrations. Эта новая папка содержит класс Configuration. Данный класс позволяет
настроить поведение Migrations в контексте. Далее выполняем **Update-Database
–** эта команда позволяет Code First Migrations перенести изменения модели в
базу данных. Запускаем проект и все работает, таблица Books создана.

![](<8.png>)

Теперь свяжем две модели и проделаем еще одну миграцию, только к
**Update-Database** добавим ключ **Verbose**, что бы посмотреть код
автоматической миграции в деле:

![](<9.png>)

**Миграции на основе кода**

Теперь, допустим нам нужно добавить к книгам рейтинг. Если сделать
**Update-Database**, то по умолчанию CLR поставит NULL для всех записей которые
уже есть в таблице, что есть не совсем корректно. Нам бы хотелось, что бы по
умолчанию рейтинг начинался с 6. Здесь мы воспользуемся командой
**Add-Migration** . Эта команда позволяет задать имя миграции и файл будет
создан в папке Migration. И так, сделаем Add-Migration BookRating, получаем файл
в папке Migrations

![](<10.png>)

Меняем рейтинг на 6

![](<11.png>)

Выполняем Update-Database и смотрим в базу

![](<12.png>)

**Вывод**

Миграции не являются обязательным требованием к разработке ПО, но они точно
облегчают жизнь разработчикам. Если используете миграции, то используйте
**миграции на основе кода**, они обладают большим контролем и ясностью чем
автоматические миграции.
